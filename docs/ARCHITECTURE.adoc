// SPDX-License-Identifier: PMPL-1.0-or-later
= AmbientOps Architecture
:toc:
:toclevels: 3

== Overview

AmbientOps is a hospital-model operations framework providing trustworthy system help without fearware. It is organised as a hybrid monorepo: core hospital departments live here, external tools integrate as satellites.

== Hospital Model

....
┌──────────────────────────────────────────────────────────────────────────────┐
│                            HOSPITAL MODEL                                    │
│                                                                              │
│  ┌──────────────────┐                                                        │
│  │      WARD        │  observatory (Elixir) — Metrics, weather, trends       │
│  │  Ambient Guidance │  (nafa-app is now a satellite repo)                   │
│  └────────┬─────────┘                                                        │
│           │ SystemWeather                                                     │
│           │                                                                  │
│  ┌────────▼─────────┐                                                        │
│  │  EMERGENCY ROOM  │  emergency-room (V) — Panic-safe intake                │
│  │  Incident Capture │  One-click stabilization, PII redaction               │
│  └────────┬─────────┘                                                        │
│           │ EvidenceEnvelope                                                  │
│           │                                                                  │
│  ┌────────▼─────────┐                                                        │
│  │  OPERATING ROOM  │  clinician (Rust) — AI-assisted sysadmin               │
│  │  Diagnosis+Apply  │  hardware-crash-team (Rust) — HW diagnostics          │
│  │                   │  composer (planned) — Orchestration engine             │
│  └────────┬─────────┘                                                        │
│           │ ProcedurePlan → Receipt                                           │
│           │                                                                  │
│  ┌────────▼─────────┐                                                        │
│  │     RECORDS      │  records/referrals (Elixir) — Multi-platform reporting  │
│  │  Audit + Referral │  Deduplication, audit log, MCP server                 │
│  └──────────────────┘                                                        │
│                                                                              │
│  ┌──────────────────┐                                                        │
│  │  DATA BACKBONE   │  contracts/ (JSON+Deno) — 8 JSON schemas              │
│  │  Contract Schemas │  contracts-rust/ (Rust) — Serde types + conversions   │
│  └──────────────────┘                                                        │
└──────────────────────────────────────────────────────────────────────────────┘
....

== Data Flow

....
┌─────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│ Emergency   │    │  Operating   │    │  Observatory │    │    Ward      │
│   Room      │    │    Room      │    │  (Ingest)    │    │  (Display)   │
│             │    │              │    │              │    │              │
│  trigger    │──▶│  scan/plan   │──▶│  ingest      │──▶│  weather     │
│  --envelope │    │  --procedure │    │  --envelope  │    │  /api/weather│
│             │    │  apply       │    │  weather     │    │              │
└─────────────┘    └──────┬───────┘    └──────────────┘    └──────────────┘
                          │
                          ▼
                   ┌──────────────┐
                   │   Records    │
                   │  submit from │
                   │   envelope   │
                   └──────────────┘

Contract chain: EvidenceEnvelope → ProcedurePlan → Receipt → SystemWeather
....

== Components

[cols="1,1,1,1,2"]
|===
| Component | Department | Language | LOC | Purpose

| clinician | Operating Room | Rust | ~4400 | AI-assisted sysadmin with diagnostic reasoning
| emergency-room | Emergency Room | V | ~1800 | Panic-safe intake, PII redaction, incident bundles
| hardware-crash-team | Operating Room | Rust | ~700 | PCI zombie detection, crash analysis, remediation plans
| observatory | Ward | Elixir | ~600 | Metrics store, bundle ingestion, weather generation
| contracts | Data Backbone | JSON+Deno | ~250 | 8 JSON schemas with cross-validation
| contracts-rust | Data Backbone | Rust | ~500 | Serde types matching JSON schemas
| records/referrals | Records | Elixir | ~400 | Multi-platform bug reporting MCP server
| composer | Operating Room | Gleam (planned) | 0 | Orchestration engine
|===

== Schema Wiring

See `contracts/WIRING.md` for the full wiring table.

**Wired (data flows today):**

* `evidence-envelope` — ER and HCT produce; observatory and records consume
* `procedure-plan` — HCT produces; clinician and composer consume
* `receipt` — ER and HCT produce; observatory ingests
* `system-weather` — observatory produces; nafa-app (satellite) displays

**Future (schema defined, not yet wired):**

* `message-intent`, `pack-manifest`, `ambient-payload`, `run-bundle`

== Technology Stack

[cols="1,1"]
|===
| Layer | Technology

| Systems / CLI | Rust (nightly, cargo workspace)
| Emergency intake | V (vlang.io)
| Observability | Elixir (OTP supervision trees)
| Application UI | ReScript (compiles to JS)
| Runtime / Package Mgmt | Deno
| Configuration | Nickel
| State / Meta files | Guile Scheme (.scm)
| Build orchestration | just (Justfile)
| Contract schemas | JSON Schema + Deno validators
|===

== Satellite Repos

External tools that integrate via contract types:

[cols="1,1,2"]
|===
| Satellite | Category | Integration

| nafa-app | Ward UI | ReScript/Deno mobile journey planner, consumes system-weather
| panic-attacker | Diagnostics | Software health scanner → verisimdb
| verisimdb / verisimdb-data | Data Pipeline | Multimodal scan result database
| hypatia | CI/CD | Neurosymbolic pattern detection → gitbot-fleet
| gitbot-fleet | Automation | Bot orchestration (rhodibot, echidnabot, etc.)
| echidna | Verification | Neurosymbolic theorem proving (30 backends)
|===

== Cross-Forge Support

AmbientOps is mirrored to GitHub, GitLab, Bitbucket, and Codeberg. The `records/referrals` MCP server supports submitting issues to all four forges plus Bugzilla and email.
